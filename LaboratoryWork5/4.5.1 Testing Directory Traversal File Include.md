## Тестування файлу проходження каталогу
|ID|
|----|
|WSTG-ATHZ-01|

## Резюме
Багато веб-додатків використовують файли та керують ними як частину своєї щоденної роботи. Використовуючи методи перевірки введення, які не були добре розроблені або розгорнуті, агресор може використовувати систему для читання або запису файлів, які не призначені для доступу. В окремих ситуаціях може бути можливим виконання довільного коду або системних команд.

Традиційно веб-сервери та веб-додатки реалізують механізми автентифікації для контролю доступу до файлів і ресурсів. Веб-сервери намагаються обмежити файли користувачів усередині «кореневого каталогу» або «кореневого каталогу веб-документа», який представляє фізичний каталог у файловій системі. Користувачі повинні розглядати цей каталог як базовий каталог в ієрархічній структурі веб-додатку.

Визначення привілеїв здійснюється за допомогою списків контролю доступу (ACL), які визначають, які користувачі або групи мають мати доступ, змінювати або виконувати певний файл на сервері. Ці механізми призначені для запобігання доступу зловмисників до конфіденційних файлів (наприклад, загального файлу /etc/passwd на UNIX-подібній платформі) або для уникнення виконання системних команд.

Багато веб-додатків використовують серверні сценарії для включення різних типів файлів. Досить поширеним є використання цього методу для керування зображеннями, шаблонами, завантаження статичних текстів тощо. На жаль, ці програми виявляють уразливість системи безпеки, якщо вхідні параметри (тобто параметри форми, значення файлів cookie) не перевірено належним чином.

У веб-серверах і веб-додатках така проблема виникає під час атак на обхід шляху/включення файлів. Використовуючи цю уразливість, зловмисник може читати каталоги чи файли, які зазвичай не може прочитати, отримувати доступ до даних за межами кореня веб-документа або включати сценарії та інші види файлів із зовнішніх веб-сайтів.

Для цілей Посібника з тестування OWASP розглядатимуться лише загрози безпеці, пов’язані з веб-додатками, а не загрози для веб-серверів (наприклад, сумнозвісний вихідний код %5c на веб-сервер Microsoft IIS). Подальші пропозиції щодо читання будуть надані в розділі літератури для зацікавлених читачів.

Цей вид атаки також відомий як атака «крапка-крапка-слеш» (../), обхід каталогу, перехід до каталогу або зворотне відстеження.

Під час оцінювання, щоб виявити недоліки в проходженні шляху та файлі, тестувальникам потрібно виконати два різні етапи:

- Перерахування вхідних векторів (систематичне оцінювання кожного вхідного вектора)
- Методи тестування (методична оцінка кожного методу атаки, який використовує зловмисник для використання вразливості)

## Цілі тесту
- Визначте точки введення, які стосуються обходу шляху.
- Оцініть методи обходу та визначте ступінь проходження шляху.
### Як тестувати
### Тестування чорної скриньки
#### Перерахування вхідних векторів
Щоб визначити, яка частина програми вразлива для обходу перевірки введення, тестувальник повинен перерахувати всі частини програми, які приймають вміст від користувача. Це також включає запити HTTP GET і POST і загальні параметри, такі як завантаження файлів і HTML-форми.

Ось кілька прикладів перевірок, які необхідно виконати на цьому етапі:

Чи існують параметри запиту, які можна використовувати для операцій, пов’язаних із файлами?
Чи існують незвичайні розширення файлів?
Є цікаві імена змінних?
http://example.com/getUserProfile.jsp?item=ikki.html
http://example.com/index.php?file=content
http://example.com/main.cgi?home=index.htm
Чи можна ідентифікувати файли cookie, які використовує веб-програма для динамічного створення сторінок або шаблонів?
Файл cookie: ID=d9ccd3f4f9f18cc1:TM=2166255468:LM=1162655568:S=3cFpqbJgMSSPKVMV:TEMPLATE=квітка
Файл cookie: USER=1826cc8f:PSTYLE=GreenDotRed

### Техніка тестування
Наступним етапом тестування є аналіз функцій перевірки вхідних даних, наявних у веб-додатку. Використовуючи попередній приклад, динамічна сторінка під назвою getUserProfile.jsp завантажує статичну інформацію з файлу та показує вміст користувачам. Зловмисник може вставити зловмисний рядок ../../../../etc/passwd, щоб включити файл хешу пароля системи Linux/UNIX. Очевидно, що такий вид атаки можливий лише в тому випадку, якщо контрольна точка перевірки дає збій; відповідно до привілеїв файлової системи, сама веб-програма повинна мати можливість читати файл.

Щоб успішно перевірити цю ваду, тестувальнику необхідно знати систему, що тестується, і розташування файлів, які запитуються. Немає сенсу запитувати /etc/passwd з веб-сервера IIS.

http://example.com/getUserProfile.jsp?item=../../../../etc/passwd
Для прикладу файлів cookie:

Файл cookie: USER=1826cc8f:PSTYLE=../../../../etc/passwd
Також можна включити файли та сценарії, розташовані на зовнішньому веб-сайті:

http://example.com/index.php?file=http://www.owasp.org/malicioustxt
Якщо протоколи приймаються як аргументи, як у наведеному вище прикладі, також можна перевірити локальну файлову систему таким чином:

http://example.com/index.php?file=file:///etc/passwd
Якщо протоколи приймаються як аргументи, як у наведених вище прикладах, також можна перевірити місцеві служби та найближчі служби:

http://example.com/index.php?file=http://localhost:8080
http://example.com/index.php?file=http://192.168.0.2:9080
Наступний приклад продемонструє, як можна показати вихідний код компонента CGI без використання будь-яких символів проходження шляху.

http://example.com/main.cgi?home=main.cgi
Компонент під назвою main.cgi розташований у тому ж каталозі, що й звичайні статичні файли HTML, які використовуються програмою. У деяких випадках тестувальнику потрібно кодувати запити за допомогою спеціальних символів (наприклад, .крапка, %00 null тощо), щоб обійти засоби керування розширеннями файлів або запобігти виконанню сценарію.

Порада. Поширеною помилкою розробників є те, що вони не очікують усіх форм кодування й тому перевіряють лише базовий закодований вміст. Якщо спочатку тестовий рядок не вдався, спробуйте іншу схему кодування.

Кожна операційна система використовує різні символи як роздільник шляху:

Unix-подібна ОС:
кореневий каталог: /
роздільник каталогу: /
ОС Windows:
кореневий каталог: <буква диска>:
роздільник каталогу: \ або /
Класична macOS:
кореневий каталог: <буква диска>:
роздільник каталогу: :
Ми повинні взяти до уваги наступні механізми кодування символів:

Кодування URL і подвійне кодування URL
%2e%2e%2f представляє ../
%2e%2e/ представляє ../
..%2f представляє ../
%2e%2e%5c представляє ..\
%2e%2e\ представляє ..\
..%5c представляє ..\
%252e%252e%255c представляє ..\
..%255c представляє ..\ і так далі.
Кодування Unicode/UTF-8 (працює лише в системах, які можуть приймати наддовгі послідовності UTF-8)
..%c0%af представляє ../
..%c1%9c представляє ..\
Існують також інші особливості ОС і фреймворку програми. Наприклад, Windows гнучка в аналізі шляхів до файлів.

Оболонка Windows: додавання будь-якого з наведеного нижче до шляхів, що використовуються в команді оболонки, не призводить до зміни функції:
Кутові дужки < і > в кінці шляху
Подвійні лапки (правильно закриті) у кінці шляху
Зайві маркери поточного каталогу, такі як ./ або .\\
Сторонні маркери батьківського каталогу з довільними елементами, які можуть існувати або не існувати:
file.txt
file.txt...
file.txt<пробіл>
файл.txt""""
file.txt<<<>>><
./././file.txt
не існує/../file.txt
Windows API: наведені нижче елементи відкидаються під час використання в будь-якій команді оболонки або виклику API, де рядок береться як ім’я файлу:
періоди
простори
Шляхи файлів Windows UNC: використовуються для посилань на файли на спільних ресурсах SMB. Іноді можна створити програму для посилання на файли на віддаленому шляху до файлу UNC. Якщо так, сервер Windows SMB може надіслати зловмиснику збережені облікові дані, які можна перехопити та зламати. Вони також можуть використовуватися з самопосиланням на IP-адресу чи доменне ім’я, щоб уникнути фільтрів, або використовуватися для доступу до файлів на спільних ресурсах SMB, недоступних для зловмисника, але доступних із веб-сервера.
\\server_or_ip\шлях\до\file.abc
\\?\server_or_ip\шлях\до\file.abc
Простір імен пристроїв Windows NT: використовується для посилання на простір імен пристроїв Windows. Певні посилання дозволять отримати доступ до файлових систем за допомогою іншого шляху.
Може бути еквівалентом літери диска, наприклад c:\, або навіть тому диска без призначеної літери: \\.\GLOBALROOT\Device\HarddiskVolume1\
Посилається на перший дисковод на машині: \\.\CdRom0\

### Тестування сірого ящика
Коли аналіз виконується за допомогою підходу тестування сірої скриньки, тестувальники повинні дотримуватися тієї ж методології, що й у тестуванні чорної скриньки. Однак, оскільки вони можуть переглядати вихідний код, можна легше й точніше шукати вхідні вектори. Під час перегляду вихідного коду вони можуть використовувати прості інструменти (такі як команда grep) для пошуку одного або кількох загальних шаблонів у коді програми: функції/методи включення, операції файлової системи тощо.

PHP: include(), include_once(), require(), require_once(), fopen(), readfile(), ...
JSP/сервлет: java.io.File(), java.io.FileReader(), ...
ASP: включити файл, включити віртуальний, ...
За допомогою онлайн-пошукових систем коду (наприклад, Searchcode) також можна знайти недоліки проходження шляху в програмному забезпеченні з відкритим кодом, опублікованому в Інтернеті.

Для PHP тестувальники можуть використовувати такий регулярний вираз:

(include|require)(_once)?\s*['"(]?\s*\$_(GET|POST|COOKIE)
Використовуючи метод тестування сірої скриньки, можна виявити вразливості, які зазвичай важче виявити або навіть неможливо знайти під час стандартної оцінки чорної скриньки.

Деякі веб-програми створюють динамічні сторінки, використовуючи значення та параметри, що зберігаються в базі даних. Коли програма додає дані до бази даних, можливо вставити спеціально створені рядки проходження шляху. Таку проблему безпеки важко виявити через те, що параметри всередині функцій включення здаються внутрішніми та безпечними, але насправді такими не є.

Крім того, переглядаючи вихідний код, можна проаналізувати функції, які повинні обробляти недійсні введення: деякі розробники намагаються змінити недійсні введення, щоб зробити їх дійсними, уникаючи попереджень і помилок.
